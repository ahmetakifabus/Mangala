<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Mangala</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const { useState, useEffect, useCallback, useRef } = React;

        // --- GEMINI API (İsteğe bağlı) ---
        const apiKey = ""; 
        let genAI = null;
        let model = null;
        if (apiKey) {
            genAI = new GoogleGenerativeAI(apiKey);
            model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
        }

        // --- İKONLAR ---
        const Icons = {
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Gamepad2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect width="20" height="12" x="2" y="6" rx="2"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Mail: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
        };

        const INITIAL_BOARD = [4, 4, 4, 4, 4, 4, 0, 4, 4, 4, 4, 4, 4, 0];

        function App() {
            const [view, setView] = useState('AUTH');
            const [user, setUser] = useState(null);
            const [gameMode, setGameMode] = useState('AI');

            const handleLogin = (userData) => {
                setUser(userData);
                setView('MENU');
            };

            const handleLogout = () => {
                setUser(null);
                setView('AUTH');
            };

            const startGame = (mode) => {
                setGameMode(mode);
                setView('GAME');
            };

            return (
                <div className="min-h-screen">
                    {view === 'AUTH' && <AuthScreen onLogin={handleLogin} />}
                    {view === 'MENU' && user && (
                        <MenuScreen 
                            username={user.username} 
                            onStartGame={startGame} 
                            onLogout={handleLogout} 
                        />
                    )}
                    {view === 'GAME' && user && (
                        <MangalaGame 
                            gameMode={gameMode} 
                            username={user.username} 
                            onExit={() => setView('MENU')} 
                        />
                    )}
                </div>
            );
        }

        function AuthScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [verificationCode, setVerificationCode] = useState('');
            const [showVerify, setShowVerify] = useState(false);
            
            const [error, setError] = useState('');
            const [successMsg, setSuccessMsg] = useState('');
            const [mode, setMode] = useState('LOGIN');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMsg('');

                if (mode === 'LOGIN') {
                    // --- GİRİŞ İŞLEMİ ---
                    if (!username || !password) { setError('Kullanıcı adı ve şifre gerekli.'); return; }
                    
                    setLoading(true);
                    try {
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password })
                        });
                        const data = await response.json();
                        if (response.ok) onLogin({ username: data.username });
                        else setError(data.error || 'Giriş başarısız.');
                    } catch (err) { setError('Bağlantı hatası.'); }
                    finally { setLoading(false); }

                } else {
                    // --- KAYIT İŞLEMLERİ ---
                    if (!showVerify) {
                        // 1. ADIM: KOD GÖNDERME
                        if (!username || !email || !password) { setError('Tüm alanları doldurun.'); return; }
                        
                        setLoading(true);
                        try {
                            const response = await fetch('/api/send-code', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username, email })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                setShowVerify(true);
                                setSuccessMsg(`Doğrulama kodu ${email} adresine gönderildi (Konsolu kontrol edin!).`);
                            } else {
                                setError(data.error || 'Kod gönderilemedi.');
                            }
                        } catch (err) { setError('Sunucu hatası.'); }
                        finally { setLoading(false); }

                    } else {
                        // 2. ADIM: DOĞRULAMA VE KAYIT
                        if (!verificationCode) { setError('Lütfen gelen kodu girin.'); return; }
                        
                        setLoading(true);
                        try {
                            const response = await fetch('/api/verify-register', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username, email, password, code: verificationCode })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                setSuccessMsg('Kayıt başarılı! Giriş yapılıyor...');
                                setTimeout(() => onLogin({ username }), 1500);
                            } else {
                                setError(data.error || 'Doğrulama başarısız.');
                            }
                        } catch (err) { setError('Kayıt işlemi başarısız.'); }
                        finally { setLoading(false); }
                    }
                }
            };

            const toggleMode = () => {
                setMode(mode === 'LOGIN' ? 'REGISTER' : 'LOGIN');
                setError('');
                setSuccessMsg('');
                setShowVerify(false);
                setVerificationCode('');
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gradient-to-br from-amber-800 to-stone-900">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-amber-600 p-6 text-center">
                            <h1 className="text-3xl font-bold text-white flex items-center justify-center gap-2">
                                <Icons.Brain /> Akıllı Mangala
                            </h1>
                            <p className="text-amber-100 mt-2">Gemini Destekli Strateji Oyunu</p>
                        </div>
                        <div className="p-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                                {mode === 'LOGIN' ? 'Giriş Yap' : 'Kayıt Ol'}
                            </h2>
                            
                            {successMsg && <div className="bg-green-100 text-green-700 p-3 rounded mb-4 text-center text-sm font-bold">{successMsg}</div>}
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {/* KULLANICI ADI - Her zaman görünür */}
                                {!showVerify && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Kullanıcı Adı</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-3 text-gray-400"><Icons.User /></div>
                                            <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                                                className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Adınız" />
                                        </div>
                                    </div>
                                )}

                                {/* E-POSTA - Sadece Kayıt modunda ve doğrulama öncesi görünür */}
                                {mode === 'REGISTER' && !showVerify && (
                                    <div className="animate-fade-in">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">E-Posta</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-3 text-gray-400"><Icons.Mail /></div>
                                            <input type="email" value={email} onChange={e => setEmail(e.target.value)}
                                                className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="ornek@mail.com" />
                                        </div>
                                    </div>
                                )}

                                {/* ŞİFRE - Doğrulama modunda gizlenir (daha temiz arayüz için) */}
                                {!showVerify && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Şifre</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-3 text-gray-400"><Icons.Lock /></div>
                                            <input type="password" value={password} onChange={e => setPassword(e.target.value)}
                                                className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="••••••" />
                                        </div>
                                    </div>
                                )}

                                {/* DOĞRULAMA KODU - Sadece kod gönderildikten sonra görünür */}
                                {showVerify && (
                                    <div className="animate-fade-in bg-amber-50 p-4 rounded-lg border border-amber-200">
                                        <label className="block text-sm font-bold text-amber-800 mb-1 text-center">E-postana Gelen Kodu Gir</label>
                                        <input type="text" value={verificationCode} onChange={e => setVerificationCode(e.target.value)}
                                            className="w-full text-center text-2xl tracking-widest py-2 border-2 border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="123456" maxLength="6" />
                                        <p className="text-xs text-center text-gray-500 mt-2">Kod gelmedi mi? Spam klasörüne bakın veya konsolu kontrol edin.</p>
                                    </div>
                                )}

                                {error && <p className="text-red-500 text-sm text-center font-medium bg-red-50 p-2 rounded">{error}</p>}
                                
                                <button type="submit" disabled={loading} className={`w-full text-white py-3 rounded-lg font-bold transition-colors shadow-lg active:scale-95 transform duration-150 ${loading ? 'bg-gray-400' : 'bg-amber-700 hover:bg-amber-800'}`}>
                                    {loading ? 'İşleniyor...' : (mode === 'LOGIN' ? 'Giriş Yap' : (showVerify ? 'Doğrula ve Tamamla' : 'Kodu Gönder'))}
                                </button>
                                
                                {showVerify && (
                                    <button type="button" onClick={() => setShowVerify(false)} className="w-full text-gray-500 text-sm underline hover:text-gray-800">
                                        Geri Dön
                                    </button>
                                )}
                            </form>
                            
                            {!showVerify && (
                                <>
                                    <div className="mt-3">
                                        <button type="button" onClick={() => onLogin({ username: 'Misafir' })} className="w-full bg-stone-200 text-stone-700 py-3 rounded-lg font-bold hover:bg-stone-300 transition-colors flex items-center justify-center gap-2">
                                            <Icons.Gamepad2 /> Demo Oyna (Üye Olmadan)
                                        </button>
                                    </div>
                                    <div className="mt-4 text-center">
                                        <button onClick={toggleMode} className="text-amber-700 font-bold hover:underline text-sm">
                                            {mode === 'LOGIN' ? 'Hesabın yok mu? Kayıt Ol' : 'Hesabın var mı? Giriş Yap'}
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function MenuScreen({ username, onStartGame, onLogout }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-stone-100 relative">
                    <button onClick={onLogout} className="absolute top-4 right-4 flex items-center gap-2 px-4 py-2 bg-white text-red-600 rounded-lg shadow hover:bg-red-50 font-medium">
                        <Icons.LogOut /> Çıkış
                    </button>
                    <div className="text-center mb-10">
                        <h1 className="text-4xl font-bold text-amber-900 mb-2">Hoşgeldin, {username}!</h1>
                        <p className="text-stone-600 text-lg">Nasıl oynamak istersin?</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                        <button onClick={() => onStartGame('AI')} className="group relative bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all border-l-8 border-purple-600 hover:-translate-y-1 text-left">
                            <div className="absolute top-4 right-4 bg-purple-100 p-3 rounded-full text-purple-600"><Icons.Brain /></div>
                            <h3 className="text-2xl font-bold text-gray-800 mb-2">Gemini Yapay Zeka</h3>
                            <p className="text-gray-500 mb-6">Seni analiz eden ve konuşan yapay zekaya karşı oyna.</p>
                            <span className="inline-flex items-center text-purple-700 font-bold group-hover:gap-2 transition-all">Başla <span className="ml-2"><Icons.ArrowRight /></span></span>
                        </button>
                        <button onClick={() => onStartGame('PVP')} className="group relative bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all border-l-8 border-green-600 hover:-translate-y-1 text-left">
                            <div className="absolute top-4 right-4 bg-green-100 p-3 rounded-full text-green-600"><Icons.Users /></div>
                            <h3 className="text-2xl font-bold text-gray-800 mb-2">2 Kişilik</h3>
                            <p className="text-gray-500 mb-6">Arkadaşınla karşılıklı oyna.</p>
                            <span className="inline-flex items-center text-green-700 font-bold group-hover:gap-2 transition-all">Başla <span className="ml-2"><Icons.ArrowRight /></span></span>
                        </button>
                    </div>
                </div>
            );
        }

        function MangalaGame({ gameMode, username, onExit }) {
            const [board, setBoard] = useState([...INITIAL_BOARD]);
            const [turn, setTurn] = useState('PLAYER');
            const [gameState, setGameState] = useState('PLAYING');
            const [winner, setWinner] = useState(null);
            const [lastMessage, setLastMessage] = useState("Başlamak için kuyu seçin.");
            const [difficulty, setDifficulty] = useState('HARD');
            const [showRules, setShowRules] = useState(false);
            
            const [aiComment, setAiComment] = useState("");
            const [isAiThinking, setIsAiThinking] = useState(false);
            const [hint, setHint] = useState(null);
            const [isGettingHint, setIsGettingHint] = useState(false);

            const isPlayerPit = (i) => i >= 0 && i <= 5;
            const isOpponentPit = (i) => i >= 7 && i <= 12;
            const getOppositePitIndex = (i) => 12 - i;

            const getStrategicHint = async () => {
                if (isGettingHint || gameState === 'ENDED') return;
                if (!apiKey) { setHint("API Anahtarı girilmediği için ipucu veremiyorum."); return; }
                
                setIsGettingHint(true);
                setHint(null);
                try {
                    const prompt = `Sen bir Mangala ustasısın. Tahta: ${JSON.stringify(board)}. Oyuncu (0-5) için en iyi hamle nedir? Türkçe ve tek cümle ile açıkla.`;
                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    setHint(response.text());
                } catch (error) {
                    setHint("Şu an yıldızlar karışık, ipucu veremiyorum.");
                } finally {
                    setIsGettingHint(false);
                }
            };

            const getAiCommentary = async (lastMoveResult, playerMoved) => {
                if (gameMode !== 'AI' || !apiKey || Math.random() > 0.4) return;
                setIsAiThinking(true);
                try {
                    const prompt = `Sen esprili bir Mangala rakibisin. Rakip: ${username}. Olay: "${lastMoveResult}". Skor: Ben ${board[13]}, Rakip ${board[6]}. 10 kelimeyi geçmeyen Türkçe, iğneleyici veya komik bir yorum yap.`;
                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    setAiComment(response.text());
                } catch (error) { } finally { setIsAiThinking(false); }
            };

            const checkGameOver = useCallback((currentBoard) => {
                const pEmpty = currentBoard.slice(0, 6).every(s => s === 0);
                const oEmpty = currentBoard.slice(7, 13).every(s => s === 0);
                if (pEmpty || oEmpty) {
                    let finalBoard = [...currentBoard];
                    let pTotal = finalBoard[6];
                    let oTotal = finalBoard[13];
                    if (pEmpty) { for (let i = 7; i <= 12; i++) { pTotal += finalBoard[i]; finalBoard[i] = 0; } finalBoard[6] = pTotal; }
                    else { for (let i = 0; i <= 5; i++) { oTotal += finalBoard[i]; finalBoard[i] = 0; } finalBoard[13] = oTotal; }
                    setBoard(finalBoard);
                    setGameState('ENDED');
                    if (pTotal > oTotal) setWinner('PLAYER'); else if (oTotal > pTotal) setWinner('OPPONENT'); else setWinner('DRAW');
                    return true;
                }
                return false;
            }, []);

            const executeMove = (idx, currentBoard, isSim = false) => {
                let temp = [...currentBoard];
                let seeds = temp[idx];
                if (seeds === 0) return { newBoard: temp, nextTurn: turn, message: "" };
                const movingPlayer = idx <= 5 ? 'PLAYER' : 'OPPONENT';
                let message = "";
                temp[idx] = 0;
                let pos = idx;
                if (seeds === 1) { pos = (pos + 1) % 14; temp[pos]++; }
                else { temp[pos]++; seeds--; while (seeds > 0) { pos = (pos + 1) % 14; if ((movingPlayer === 'PLAYER' && pos === 13) || (movingPlayer === 'OPPONENT' && pos === 6)) continue; temp[pos]++; seeds--; } }
                let nextTurn = movingPlayer === 'PLAYER' ? 'OPPONENT' : 'PLAYER';
                if ((movingPlayer === 'PLAYER' && pos === 6) || (movingPlayer === 'OPPONENT' && pos === 13)) { nextTurn = movingPlayer; message = isSim ? "" : "Son taş hazineye! Sıra sende."; }
                else if (((movingPlayer === 'PLAYER' && isOpponentPit(pos)) || (movingPlayer === 'OPPONENT' && isPlayerPit(pos))) && temp[pos] % 2 === 0) { const tr = movingPlayer === 'PLAYER' ? 6 : 13; temp[tr] += temp[pos]; temp[pos] = 0; message = isSim ? "" : "Çift yapıp aldın!"; }
                else if (((movingPlayer === 'PLAYER' && isPlayerPit(pos)) || (movingPlayer === 'OPPONENT' && isOpponentPit(pos))) && temp[pos] === 1) { const op = 12 - pos; if (temp[op] > 0) { const tr = movingPlayer === 'PLAYER' ? 6 : 13; temp[tr] += temp[pos] + temp[op]; temp[pos] = 0; temp[op] = 0; message = isSim ? "" : "Boş kuyu kuralı!"; } }
                return { newBoard: temp, nextTurn, message };
            };

            const handlePitClick = (index) => {
                if (gameState === 'ENDED' || (gameMode === 'AI' && turn === 'OPPONENT')) return;
                setHint(null);
                const isMyTurn = (turn === 'PLAYER' && isPlayerPit(index)) || (turn === 'OPPONENT' && isOpponentPit(index));
                if (!isMyTurn || board[index] === 0) return;
                const res = executeMove(index, board);
                setBoard(res.newBoard);
                setTurn(res.nextTurn);
                if (gameMode === 'AI' && res.message) getAiCommentary(res.message, true);
                if (res.message) setLastMessage(res.message);
                else setLastMessage(res.nextTurn === 'PLAYER' ? `${username} oynuyor...` : (gameMode === 'AI' ? "Gemini düşünüyor..." : "2. Oyuncu oynuyor..."));
            };

            useEffect(() => {
                if (gameMode === 'AI' && turn === 'OPPONENT' && gameState === 'PLAYING') { const timer = setTimeout(() => makeCpuMove(), 1500); return () => clearTimeout(timer); }
                if (gameState === 'PLAYING') checkGameOver(board);
            }, [turn, board, gameState]);

            const makeCpuMove = () => {
                const validMoves = [7,8,9,10,11,12].filter(i => board[i] > 0);
                if (validMoves.length === 0) return;
                let selected = validMoves[0];
                if (difficulty === 'HARD') { let bestScore = -9999; validMoves.forEach(move => { const sim = executeMove(move, board, true); const gain = sim.newBoard[13] - board[13]; const bonus = sim.nextTurn === 'OPPONENT' ? 10 : 0; const score = gain * 2 + bonus; if (score > bestScore) { bestScore = score; selected = move; } }); }
                else { selected = validMoves[Math.floor(Math.random() * validMoves.length)]; }
                const res = executeMove(selected, board);
                setBoard(res.newBoard);
                setTurn(res.nextTurn);
                if (res.message) getAiCommentary(res.message, false);
                if (res.message) setLastMessage(res.message);
                else setLastMessage(res.nextTurn === 'PLAYER' ? `${username} oynuyor...` : "Bilgisayar oynadı.");
            };

            const renderSeeds = (count, isTreasury = false) => {
                if (count === 0) return null;
                const visualCount = Math.min(count, isTreasury ? 20 : 10);
                return (
                    <div className="relative w-full h-full flex items-center justify-center">
                        <div className="absolute inset-0 flex flex-wrap content-center justify-center p-2 gap-1 pointer-events-none">
                            {Array.from({ length: visualCount }).map((_, i) => (
                                <div key={i} className={`rounded-full shadow-sm border border-black/10 ${isTreasury ? 'w-3 h-3 md:w-4 md:h-4' : 'w-3 h-3 md:w-4 md:h-4'} ${i%3===0?'bg-amber-100':i%3===1?'bg-blue-200':'bg-green-200'}`} style={{transform: `translate(${Math.random()*4-2}px, ${Math.random()*4-2}px)`}} />
                            ))}
                        </div>
                        <span className="relative z-10 font-bold text-white text-xl md:text-2xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">{count}</span>
                    </div>
                );
            };

            const player1Name = username;
            const player2Name = gameMode === 'AI' ? 'GEMINI AI' : 'OYUNCU 2';
            const getWinnerMessage = () => { if (winner === 'PLAYER') return `${player1Name} KAZANDI!`; if (winner === 'OPPONENT') return `${player2Name} KAZANDI!`; return "BERABERE!"; };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-stone-100">
                    <div className="w-full max-w-4xl mb-6">
                        <button onClick={onExit} className="text-stone-500 hover:text-stone-800 font-bold mb-2 flex items-center gap-1">← Menü</button>
                        <div className="flex w-full justify-between items-center bg-white p-4 rounded-xl shadow-md border-l-4 border-amber-600 relative">
                            <div className={`flex flex-col items-center transition-all ${turn === 'PLAYER' ? 'opacity-100 scale-105' : 'opacity-60'}`}><div className="flex items-center gap-2 text-blue-700 font-bold"><Icons.User /> {player1Name.toUpperCase()}</div><span className="text-3xl font-bold">{board[6]}</span></div>
                            <div className="flex flex-col items-center text-center px-4 flex-1">
                                <div className="text-amber-800 font-bold animate-pulse-slow px-3 py-1 bg-amber-100 rounded-full text-sm">{gameState === 'ENDED' ? getWinnerMessage() : lastMessage}</div>
                                {gameMode === 'AI' && aiComment && (
                                    <div className="absolute top-16 md:top-20 right-0 md:right-20 z-20 max-w-[200px] animate-bounce-slow">
                                        <div className="bg-white border-2 border-purple-500 text-purple-800 p-2 rounded-lg rounded-tr-none text-xs md:text-sm shadow-lg relative">
                                            {isAiThinking ? <span className="animate-pulse">...</span> : `"${aiComment}"`}
                                            <div className="absolute -top-2 right-0 w-4 h-4 bg-white border-t-2 border-r-2 border-purple-500 transform rotate-45"></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className={`flex flex-col items-center transition-all ${turn === 'OPPONENT' ? 'opacity-100 scale-105' : 'opacity-60'}`}><div className="flex items-center gap-2 text-purple-700 font-bold">{player2Name} {gameMode === 'AI' ? <Icons.Sparkles /> : <Icons.User />}</div><span className="text-3xl font-bold">{board[13]}</span></div>
                        </div>
                    </div>

                    {turn === 'PLAYER' && gameState === 'PLAYING' && (
                        <div className="mb-4 w-full max-w-5xl flex justify-center">
                            {hint ? (
                                <div className="bg-blue-100 text-blue-800 p-3 rounded-lg shadow-md border border-blue-300 flex items-center gap-2 animate-fade-in max-w-lg">
                                    <Icons.Brain size={18} className="shrink-0"/><span className="text-sm">{hint}</span><button onClick={() => setHint(null)} className="ml-auto text-blue-500 hover:text-blue-900 font-bold">✕</button>
                                </div>
                            ) : (
                                <button onClick={getStrategicHint} disabled={isGettingHint} className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-5 py-2 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2 text-sm font-bold">
                                    {isGettingHint ? <Icons.RefreshCw className="animate-spin" /> : <Icons.Sparkles />} {isGettingHint ? "Gemini Analiz Ediyor..." : "Gemini'dan İpucu Al"}
                                </button>
                            )}
                        </div>
                    )}

                    <div className="relative bg-[#5D4037] p-4 md:p-8 rounded-[3rem] shadow-[0_20px_50px_rgba(0,0,0,0.5)] border-8 border-[#3E2723] w-full max-w-5xl">
                        <div className="flex justify-between h-64 md:h-80 gap-2 md:gap-4">
                            <div className="w-24 md:w-32 h-full bg-[#3E2723] rounded-full flex items-center justify-center border-4 border-[#8D6E63] relative overflow-hidden shadow-inner">{renderSeeds(board[13], true)}</div>
                            <div className="flex-1 flex flex-col justify-between py-2">
                                <div className={`flex justify-around mb-4 p-2 rounded-xl transition-colors ${turn === 'OPPONENT' && gameMode === 'PVP' ? 'bg-white/10' : ''}`}>
                                    {[12,11,10,9,8,7].map(i => (
                                        <div key={i} onClick={() => gameMode === 'PVP' && turn === 'OPPONENT' && board[i] > 0 && handlePitClick(i)} className={`w-12 h-12 md:w-20 md:h-20 bg-[#4E342E] rounded-full flex items-center justify-center shadow-inner border-2 border-[#8D6E63] relative transition-all ${turn === 'OPPONENT' && board[i]>0 ? (gameMode==='PVP'?'cursor-pointer hover:bg-[#5D4037] ring-4 ring-red-400':'ring-2 ring-purple-400 opacity-90'):''}`}>
                                            <span className="absolute -top-6 text-white/30 text-xs font-bold">{i}</span>{renderSeeds(board[i])}
                                        </div>
                                    ))}
                                </div>
                                <div className="w-full h-1 bg-[#8D6E63]/30 rounded-full mx-auto my-1"></div>
                                <div className={`flex justify-around mt-4 p-2 rounded-xl transition-colors ${turn === 'PLAYER' ? 'bg-white/10' : ''}`}>
                                    {[0,1,2,3,4,5].map(i => (
                                        <button key={i} onClick={() => handlePitClick(i)} disabled={turn !== 'PLAYER' || board[i] === 0 || gameState === 'ENDED'} className={`w-12 h-12 md:w-20 md:h-20 bg-[#4E342E] rounded-full flex items-center justify-center shadow-inner border-2 border-[#8D6E63] relative transition-all active:scale-95 ${turn === 'PLAYER' && board[i] > 0 ? 'cursor-pointer hover:bg-[#5D4037] ring-4 ring-green-400 hover:shadow-[0_0_15px_rgba(74,222,128,0.5)]' : 'opacity-90'}`}>
                                            {renderSeeds(board[i])}<span className="absolute -bottom-6 text-white/30 text-xs font-bold">{i+1}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="w-24 md:w-32 h-full bg-[#3E2723] rounded-full flex items-center justify-center border-4 border-[#8D6E63] relative overflow-hidden shadow-inner">{renderSeeds(board[6], true)}</div>
                        </div>
                    </div>

                    <div className="mt-8 flex gap-4 flex-wrap justify-center">
                        <button onClick={() => { setBoard([...INITIAL_BOARD]); setTurn('PLAYER'); setGameState('PLAYING'); setWinner(null); setLastMessage("Yeni oyun başladı."); setAiComment(""); setHint(null); }} className="flex items-center gap-2 px-6 py-3 bg-white text-stone-800 rounded-lg shadow hover:bg-stone-50 font-bold"><Icons.RefreshCw /> Yeniden</button>
                        {gameMode === 'AI' && (
                            <button onClick={() => setDifficulty(d => d === 'EASY' ? 'HARD' : 'EASY')} className={`flex items-center gap-2 px-6 py-3 rounded-lg shadow text-white font-bold w-40 justify-center ${difficulty === 'HARD' ? 'bg-purple-600' : 'bg-blue-500'}`}>
                                {difficulty === 'HARD' ? <><Icons.Brain /> Zor</> : <><Icons.Users /> Kolay</>}
                            </button>
                        )}
                        <button onClick={() => setShowRules(!showRules)} className="flex items-center gap-2 px-6 py-3 bg-amber-600 text-white rounded-lg shadow hover:bg-amber-700 font-bold"><Icons.Info /> Kurallar</button>
                    </div>

                    {showRules && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl p-6 max-w-lg w-full shadow-2xl relative">
                                <button onClick={() => setShowRules(false)} className="absolute top-4 right-4 text-gray-500 font-bold text-xl">✕</button>
                                <h2 className="text-2xl font-bold text-amber-800 mb-4">Kurallar</h2>
                                <ul className="list-disc pl-5 text-gray-700 text-sm space-y-2">
                                    <li>Kendi kuyunuzdan taşları alıp saat yönünün tersine dağıtın.</li>
                                    <li>Son taş hazinenize gelirse tekrar oynarsınız.</li>
                                    <li>Son taş rakip kuyuyu çift yaparsa hepsini alırsınız.</li>
                                    <li>Son taş kendi boş kuyunuza gelirse hem kendi taşınızı hem rakibin taşını alırsınız.</li>
                                </ul>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
